#!/usr/bin/env ruby

require 'beans'
require 'daemons'

if ARGV.length==0

  begin
    s = Beans::BeanCounter.new
    $stdout.printf "$%.02f\n", s.query.to_f

  rescue Errno::ECONNREFUSED
    begin
      # Presumably there's no server running, so let's just count some beans.
      s = Beans::Stopwatch.new

      while true do
        $stdout.printf "\r$%.02f", s.query('dollars')
        sleep(0.25)
      end
    rescue Interrupt
      $stdout.printf "\n"
    end
  end


elsif ARGV.include? '-f'

  begin

    s = Beans::BeanCounter.new

    while true do
      $stdout.printf "\r$%.02f", s.query.to_f
      sleep(0.25)
    end

  rescue Interrupt
    $stdout.printf "\n"

  rescue Errno::ECONNREFUSED
    $stderr.puts "Unable to connect to bean server! Are you sure it's running on port #{Beans::Config.port}?"

  rescue Errno::EPIPE
    $stderr.printf "\nLost connection with bean server!\n"

  end


else
  Daemons.run('bin/bean_server')
end
