#!/usr/bin/env ruby

require 'beans'

if ARGV.length==0

  begin
    s = Beans::BeanCounter.new
    $stdout.printf "$%.02f\n", s.query.to_f

  rescue Errno::ECONNREFUSED
    begin
      # Presumably there's no server running, so let's just count some beans.
      s = Beans::Stopwatch.new
      s.start

      while true do
        $stdout.printf "\r$%.02f", s.query('dollars')
        sleep(0.25)
      end
    rescue Interrupt
      $stdout.printf "\n"
    end
  end


elsif ARGV.include? '-t'

  begin

    s = Beans::BeanCounter.new

    while true do
      $stdout.printf "\r$%.02f", s.query.to_f
      sleep(0.25)
    end

  rescue Interrupt
    $stdout.printf "\n"

  rescue Errno::ECONNREFUSED
    $stderr.puts "Unable to connect to beans server! Are you sure it's running on port #{Beans::Config.port}?"

  rescue Errno::EPIPE
    $stderr.printf "\nLost connection with beans server!\n"

  end

else

  s = Beans::BeanCounter.new
  case ARGV[0].strip.downcase
    when 'start'
      s.query('start')
    when 'stop'
      s.query('stop')
  end

end
